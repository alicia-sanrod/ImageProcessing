<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>51ae1b2b7abf4f6cb82f5f933fd52d78</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell markdown" id="DhrqiuiILIQj">
<p>Alicia Sanguino y Sandra Pinel</p>
<p>##<strong>PROCESAMIENTO DE IMAGEN IA - ALGORITMO DE CLASIFICACIÓN DE
ENFERMEDADES DE LA RETINA</strong></p>
<p>La tarea consiste en crear un algoritmo que detecte a través de
imágenes retinales si la persona padece o no de una enfermedad retinal.
El modelo se creará a través del conjunto de datos proporcionados por la
base de datos <em>'Retinal disease Classification'</em> de Kaggle: <a
href="https://www.kaggle.com/datasets/andrewmvd/retinal-disease-classification"
class="uri">https://www.kaggle.com/datasets/andrewmvd/retinal-disease-classification</a></p>
</div>
<div class="cell markdown" id="Z7ecyzx0DLFa">
<p><strong>IMPORTANCIÓN DE BIBLIOTECAS Y MÓDULOS NECESARIOS</strong></p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="jDRojFTtNT8y" data-outputId="cbfb7f37-cde2-493a-d640-329aad13ab48">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Conectamos el drive con el google Colab</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Mounted at /content/drive
</code></pre>
</div>
</div>
<div class="cell code" id="Yh-yplE1RKih">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Importanción de bibliotecas esenciales</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.image <span class="im">as</span> mpimg</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">&quot;whitegrid&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Módulos para sistema de archivos</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Módulos para el entrenamiento y transfer learning</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Dense,Flatten</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow.keras.applications <span class="im">as</span> cnns</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> Model</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Módulos para la evaluación del modelo</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, classification_report, f1_score</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve, precision_recall_curve</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Módulos para el ensamblaje</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> collections</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Desactivación de logs de TensorFlow</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging, os</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>logging.disable(logging.WARNING)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">&quot;TF_CPP_MIN_LOG_LEVEL&quot;</span>] <span class="op">=</span> <span class="st">&quot;3&quot;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Definición de constantes</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>TRAIN_CSV_DIR <span class="op">=</span> <span class="st">&quot;/content/drive/MyDrive/Trabajo_Retina/Training_Set/RFMiD_Training_Labels.csv&quot;</span>  <span class="co">#cambiar ruta a donde tengas tú la carpeta compartida con las imágenes</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>TEST_CSV_DIR <span class="op">=</span> <span class="st">&quot;/content/drive/MyDrive/Trabajo_Retina/Test_Set/RFMiD_Testing_Labels.csv&quot;</span></span></code></pre></div>
</div>
<div class="cell markdown" id="unuqxDbiFlZB">
<p>En este primer código:</p>
<ol>
<li><p>Se importan las bibliotecas esenciales como Pandas para
manipulación de datos, NumPy para operaciones numéricas, Matplotlib y
Seaborn para visualización. Y otras bibliotecas para el ensamblaje del
modelo (<code>collections</code>).</p></li>
<li><p>Se importan módulos relacionados con el sistema de archivos para
trabajar con directorios y archivos JSON; módulos de Tensor Flow y Keras
para construir modelos de aprendizaje profundo; módulos de scikit-learn
para evaluar el rendimiento del modelo, como la precisión y la
puntuación F1.</p></li>
<li><p>Se desactivan los registros de Tensorflow para reducir la
cantidad de información que se imprime en la consosola durante la
ejecución del código, como mensajes de información o advertencia que no
son esenciales para la compresión del código.</p></li>
<li><p>Se definen las constantes <em>TRAIN_CSV_DIR</em> y
<em>TEST_CSV_DIR</em> que contienen las rutas a los archivos CSV con la
información sobre las etiquetas de las imágenes que forman el conjunto
de train y test.</p></li>
</ol>
</div>
<div class="cell markdown" id="iHnYCPmGVisp">
<p><strong>VERIFICACIÓN Y DETERMINACIÓN DEL ENTORNO DE
EJECUCIÓN</strong></p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="7RudNfrVRUhi" data-outputId="773418d4-5bbb-4acc-b074-3264fc305cd0">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lista de dispositivos físicos disponibles para Tensorflow</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>physical_devices <span class="op">=</span> tf.config.list_physical_devices()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> device <span class="kw">in</span> physical_devices:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(device)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>PhysicalDevice(name=&#39;/physical_device:CPU:0&#39;, device_type=&#39;CPU&#39;)
PhysicalDevice(name=&#39;/physical_device:GPU:0&#39;, device_type=&#39;GPU&#39;)
</code></pre>
</div>
</div>
<div class="cell markdown" id="BEeQsTVkdWBF">
<p>Especificamos el entorno en el que se ejecutarán las operaciones de
TensorFlow. Si se detecta una GPU, se configura tf_device para que
Tensorflow utilice la GPU; de lo contrario, se configura para que
utilice la CPU. Esto nos permite seleccionar automáticamente el
dispositivo adecuado según la disponibilidad de hardware.</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="Gj90YkXZVCmX" data-outputId="22533c36-2cfd-4588-db3a-0647a73a5d7c">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar si hay al menos una GPU disponible</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gpu_available <span class="op">=</span> tf.test.is_gpu_available()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> gpu_available:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Se está usando la GPU disponible en tu sistema.&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Se está usando la CPU disponible en tu sistema&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Se está usando la GPU disponible en tu sistema.
</code></pre>
</div>
</div>
<div class="cell markdown" id="nsaYlcxIa6Ji">
<p><strong>VISUALIZACIÓN Y PROCESAMIENTO DE DATOS DEL CONJUNTO DE
ENTRENAMIENTO Y TEST</strong></p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="i5hzTSCMRXzc" data-outputId="8f581504-41c9-4cfa-9e44-b53cc3573b30">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Leemos los datos de los archivos csv</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> pd.read_csv(TRAIN_CSV_DIR)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> pd.read_csv(TEST_CSV_DIR)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Vemos el tamaño del train-set y test-set</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;El conjunto de train tiene&quot;</span>, <span class="bu">len</span>(train_data), <span class="st">&quot;imágenes&quot;</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;El conjunto de test tiene&quot;</span>, <span class="bu">len</span>(test_data), <span class="st">&quot;imágenes&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>El conjunto de train tiene 1920 imágenes
El conjunto de test tiene 640 imágenes
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:236}"
id="cZMSOIGHRaMu" data-outputId="43fde0d3-3aea-4122-9ef1-0736b5b5164a">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Imprimimos las primeras filas del DataFrame de train_labels</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>train_data.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="6">

  <div id="df-4a050442-88ee-4ed3-808d-a4a0f67391c2" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Disease_Risk</th>
      <th>DR</th>
      <th>ARMD</th>
      <th>MH</th>
      <th>DN</th>
      <th>MYA</th>
      <th>BRVO</th>
      <th>TSLN</th>
      <th>ERM</th>
      <th>...</th>
      <th>CME</th>
      <th>PTCR</th>
      <th>CF</th>
      <th>VH</th>
      <th>MCA</th>
      <th>VS</th>
      <th>BRAO</th>
      <th>PLQ</th>
      <th>HPED</th>
      <th>CL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 47 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-4a050442-88ee-4ed3-808d-a4a0f67391c2')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-4a050442-88ee-4ed3-808d-a4a0f67391c2 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-4a050442-88ee-4ed3-808d-a4a0f67391c2');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-bebfca2c-b6e1-44b0-a741-1236addb589b">
  <button class="colab-df-quickchart" onclick="quickchart('df-bebfca2c-b6e1-44b0-a741-1236addb589b')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-bebfca2c-b6e1-44b0-a741-1236addb589b button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell markdown" id="ZczvN4H6XCf4">
<p>Creamos un diccionario llamado infected_retinas que contiene las dos
patologías más frecuentes en las imágenes de retina. Esto se logra
eliminando las columnas "ID" y "Disease_Risk" del DataFrame
train_labels, sumando el número de ocurrencias de cada infección,
ordenando los resultados en orden descendente y tomando las dos primeras
entradas (que son las dos infecciones más frecuentes). Se prueba tanto
para el conjunto de datos de train como el de test, para ver que que
ambas obtienen el mismo resultado sobre las enfermedades más
frecuentes:</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="e_9mxX1SYIA9" data-outputId="4290103b-b0dc-46e8-e54f-5ef283b4216b">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Para el conjunto Train</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sick_retinas <span class="op">=</span> <span class="bu">dict</span>(train_data.drop([<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;Disease_Risk&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">2</span>))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sick_retinas</span></code></pre></div>
<div class="output execute_result" data-execution_count="7">
<pre><code>{&#39;DR&#39;: 376, &#39;MH&#39;: 317}</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="npdmEVaDbR6H" data-outputId="ec6013c4-1429-4d6a-ef7b-11fd68ccd924">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Para el conjunto Test</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>sick_retinas2 <span class="op">=</span> <span class="bu">dict</span>(test_data.drop([<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;Disease_Risk&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">2</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>sick_retinas2</span></code></pre></div>
<div class="output execute_result" data-execution_count="8">
<pre><code>{&#39;DR&#39;: 124, &#39;MH&#39;: 104}</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="3U05BnTVZRCk" data-outputId="6c340806-c520-48a9-f89b-86c0cf67fa1b">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Creamos una lista con las claves ( 2 infecciones + frecuentes) del diccionario creado antes</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(sick_retinas.keys())</span></code></pre></div>
<div class="output execute_result" data-execution_count="9">
<pre><code>[&#39;DR&#39;, &#39;MH&#39;]</code></pre>
</div>
</div>
<div class="cell markdown" id="GEUrFew4dFJQ">
<p>En ambas sale que las enfermedades más frecuentes son la 'Diabetic
retinopathy' (DR) y 'Macular Hole' (MH). En español se conocen con el
nombre de retinopatía diabética y agujero macular respectivamente.</p>
</div>
<div class="cell code" id="yoY3NR4DRlxf">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Modificamos los Dataframes para incluir solo las columnas &quot;ID&quot; y las dos infecciones más frecuentes</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> train_data[[<span class="st">&quot;ID&quot;</span>]<span class="op">+</span><span class="bu">list</span>(sick_retinas.keys())]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> test_data[[<span class="st">&quot;ID&quot;</span>]<span class="op">+</span><span class="bu">list</span>(sick_retinas.keys())]</span></code></pre></div>
</div>
<div class="cell markdown" id="W1_AlTf6Nvr1">
<p>Como nuestro objetivo es crear un modelo de clasificación binaria que
nos diga si el paciente padece o no una patología retinal, hay que crear
una nueva columna llamada "Etiquetas" que tiene el valor 1 si al menos
uno de los valores en las columnas "Diabetic Retinopathy" o "Macular
Hole" es 1, y 0 si ambos son 0. Después crearemos una nueva columna
llamada 'Clase' que contendrá la palabra 'Enfermo' si el valor de la
columna 'Enfermo' es 1, y 'No enfermo' si el valor es 0.</p>
</div>
<div class="cell code" id="Oyu5aNPwPurn">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la columna &#39;Etiquetas&#39;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>train_data[<span class="st">&#39;Etiquetas&#39;</span>] <span class="op">=</span> train_data.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row[<span class="st">&#39;DR&#39;</span>] <span class="op">==</span> <span class="dv">1</span> <span class="kw">or</span> row[<span class="st">&#39;MH&#39;</span>] <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>test_data[<span class="st">&#39;Etiquetas&#39;</span>] <span class="op">=</span> test_data.<span class="bu">apply</span>(<span class="kw">lambda</span> row: <span class="dv">1</span> <span class="cf">if</span> row[<span class="st">&#39;DR&#39;</span>] <span class="op">==</span> <span class="dv">1</span> <span class="kw">or</span> row[<span class="st">&#39;MH&#39;</span>] <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear la columna &#39;Clase&#39;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>train_data[<span class="st">&#39;Clase&#39;</span>] <span class="op">=</span> train_data[<span class="st">&#39;Etiquetas&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">&#39;Enfermo&#39;</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">&#39;No enfermo&#39;</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>test_data[<span class="st">&#39;Clase&#39;</span>] <span class="op">=</span> test_data[<span class="st">&#39;Etiquetas&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">&#39;Enfermo&#39;</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">&#39;No enfermo&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="AQ2c_cUhQiUB" data-outputId="03487693-99c1-49d7-e6a2-c7930e6da1aa">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>train_data.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="12">

  <div id="df-9430edae-4fe7-4f60-be90-ff6655541aaf" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>DR</th>
      <th>MH</th>
      <th>Etiquetas</th>
      <th>Clase</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-9430edae-4fe7-4f60-be90-ff6655541aaf')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-9430edae-4fe7-4f60-be90-ff6655541aaf button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-9430edae-4fe7-4f60-be90-ff6655541aaf');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-2b22fc0e-c7ef-4852-b970-a08d7a5e6f0f">
  <button class="colab-df-quickchart" onclick="quickchart('df-2b22fc0e-c7ef-4852-b970-a08d7a5e6f0f')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-2b22fc0e-c7ef-4852-b970-a08d7a5e6f0f button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="QkLDVofMQvQg" data-outputId="ebb7dd3e-923d-4cc9-fd73-c71acb6d0a36">
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>test_data.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="13">

  <div id="df-a27bf832-0c08-4884-8833-cff3a95aaf16" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>DR</th>
      <th>MH</th>
      <th>Etiquetas</th>
      <th>Clase</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-a27bf832-0c08-4884-8833-cff3a95aaf16')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-a27bf832-0c08-4884-8833-cff3a95aaf16 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-a27bf832-0c08-4884-8833-cff3a95aaf16');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-4d3edfdc-293d-4973-97e3-1270f66b61e2">
  <button class="colab-df-quickchart" onclick="quickchart('df-4d3edfdc-293d-4973-97e3-1270f66b61e2')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-4d3edfdc-293d-4973-97e3-1270f66b61e2 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell markdown" id="N_kWuq7nlASw">
<p>ESTO IR VIENDO COMO AJUSTAR: 1920 imágenes y 640 imágenes es una
cantidad que sobrepasa nuestros límites y recursos. Para ellos
seleccionaremos 200 imágenes para el entrenamiento y 60 imágenes para el
testing. La selección de estas imágenes se hará de forma aleatoria y con
un muestreo estratificado para evitar el desequilibrio de clases.</p>
</div>
<div class="cell code" id="XHcHVTY2mtVj">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Número total de imágenes que deseas seleccionar para entrenamiento y prueba</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>total_train_samples <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>total_test_samples <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Estratificación manual para garantizar la proporción de clases</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>train_stratified, _ <span class="op">=</span> train_test_split(train_data, stratify<span class="op">=</span>train_data[<span class="st">&quot;Etiquetas&quot;</span>], test_size<span class="op">=</span>(<span class="bu">len</span>(train_data)<span class="op">-</span>total_train_samples), random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>test_stratified, _ <span class="op">=</span> train_test_split(test_data, stratify<span class="op">=</span>test_data[<span class="st">&quot;Etiquetas&quot;</span>], test_size<span class="op">=</span>(<span class="bu">len</span>(test_data)<span class="op">-</span>total_test_samples), random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Muestreo aleatorio para seleccionar el número deseado de muestras</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> train_stratified.sample(n<span class="op">=</span>total_train_samples, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> test_stratified.sample(n<span class="op">=</span>total_test_samples, random_state<span class="op">=</span><span class="dv">42</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="ew98-_etnShe">
<p>Observamos la forma de los Dataframes y calculamos la longitud de
cada uno de los sets para comprobar que tengamos 200 y 60
respectivamente:</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="8cyTjakmnR8F" data-outputId="501f004b-31d4-467e-ee0d-2a2fc2f0fe43">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>train_data</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;El conjunto de train tiene&quot;</span>, <span class="bu">len</span>(train_data), <span class="st">&quot;imágenes&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>El conjunto de train tiene 200 imágenes
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:424}"
id="nlTMS49Jo2Y_" data-outputId="ca8cd516-9878-4f2c-ba4d-d4b1c558990d">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>train_data</span></code></pre></div>
<div class="output execute_result" data-execution_count="16">

  <div id="df-8605618b-73ad-42a3-a83c-d9dcf042f0e4" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>DR</th>
      <th>MH</th>
      <th>Etiquetas</th>
      <th>Clase</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>818</th>
      <td>819</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>19</th>
      <td>20</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>696</th>
      <td>697</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>1819</th>
      <td>1820</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>1568</th>
      <td>1569</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>145</th>
      <td>146</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>1714</th>
      <td>1715</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>387</th>
      <td>388</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>341</th>
      <td>342</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>141</th>
      <td>142</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
  </tbody>
</table>
<p>200 rows × 5 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-8605618b-73ad-42a3-a83c-d9dcf042f0e4')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-8605618b-73ad-42a3-a83c-d9dcf042f0e4 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-8605618b-73ad-42a3-a83c-d9dcf042f0e4');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-27acfcda-f05b-4e70-862b-a6eb14a67f5a">
  <button class="colab-df-quickchart" onclick="quickchart('df-27acfcda-f05b-4e70-862b-a6eb14a67f5a')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-27acfcda-f05b-4e70-862b-a6eb14a67f5a button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="JwWTBCTqoQfa" data-outputId="52a59a93-5828-4c8c-f8f0-f40e6063132d">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>test_data</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;El conjunto de test tiene&quot;</span>, <span class="bu">len</span>(test_data), <span class="st">&quot;imágenes&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>El conjunto de test tiene 60 imágenes
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1000}"
id="z8UhkwsLpQDW" data-outputId="538ba1b1-b6a1-4d25-f335-636fffe444a2">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>test_data</span></code></pre></div>
<div class="output execute_result" data-execution_count="18">

  <div id="df-c036abe4-9f43-4001-9634-ac199ee9f5b0" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>DR</th>
      <th>MH</th>
      <th>Etiquetas</th>
      <th>Clase</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>103</th>
      <td>104</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>38</th>
      <td>39</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>475</th>
      <td>476</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>561</th>
      <td>562</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>424</th>
      <td>425</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>266</th>
      <td>267</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>146</th>
      <td>147</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>531</th>
      <td>532</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>515</th>
      <td>516</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>116</th>
      <td>117</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>139</th>
      <td>140</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>158</th>
      <td>159</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>14</th>
      <td>15</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>619</th>
      <td>620</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>477</th>
      <td>478</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>172</th>
      <td>173</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>75</th>
      <td>76</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>629</th>
      <td>630</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>582</th>
      <td>583</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>442</th>
      <td>443</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>135</th>
      <td>136</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>324</th>
      <td>325</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>610</th>
      <td>611</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>264</th>
      <td>265</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>179</th>
      <td>180</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>47</th>
      <td>48</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>638</th>
      <td>639</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>186</th>
      <td>187</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>613</th>
      <td>614</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>63</th>
      <td>64</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>91</th>
      <td>92</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>380</th>
      <td>381</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>64</th>
      <td>65</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>368</th>
      <td>369</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>634</th>
      <td>635</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>260</th>
      <td>261</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>560</th>
      <td>561</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>387</th>
      <td>388</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>166</th>
      <td>167</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>85</th>
      <td>86</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>499</th>
      <td>500</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>241</th>
      <td>242</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>490</th>
      <td>491</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>216</th>
      <td>217</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>528</th>
      <td>529</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>624</th>
      <td>625</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>129</th>
      <td>130</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>102</th>
      <td>103</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>131</th>
      <td>132</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>162</th>
      <td>163</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>616</th>
      <td>617</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>632</th>
      <td>633</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>101</th>
      <td>102</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>208</th>
      <td>209</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>95</th>
      <td>96</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>41</th>
      <td>42</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
    <tr>
      <th>510</th>
      <td>511</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>348</th>
      <td>349</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
    </tr>
    <tr>
      <th>93</th>
      <td>94</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-c036abe4-9f43-4001-9634-ac199ee9f5b0')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-c036abe4-9f43-4001-9634-ac199ee9f5b0 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-c036abe4-9f43-4001-9634-ac199ee9f5b0');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-9d218e21-abb4-4dec-8332-64f916c2c711">
  <button class="colab-df-quickchart" onclick="quickchart('df-9d218e21-abb4-4dec-8332-64f916c2c711')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-9d218e21-abb4-4dec-8332-64f916c2c711 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell markdown" id="GwkDEpHvfHB4">
<p>Definimos una función para obtener la ruta de una imagen específica
proporcionando el identificador y el directorio correspondiente:</p>
</div>
<div class="cell code" id="NrOZpHN120Eh">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>TRAIN_IMG_DIR<span class="op">=</span><span class="st">&quot;/content/drive/MyDrive/Trabajo_Retina/Training_Set/TRAIN&quot;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>TEST_IMG_DIR <span class="op">=</span> <span class="st">&quot;/content/drive/MyDrive/Trabajo_Retina/Test_Set/TEST&quot;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> id_to_path(<span class="bu">id</span> : <span class="bu">int</span>, IMG_DIR : <span class="bu">str</span>):</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> os.path.join(IMG_DIR, <span class="bu">str</span>(<span class="bu">id</span>) <span class="op">+</span> <span class="st">&quot;.png&quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="yW1u9guD3BDq">
<p>Agregamos una nueva columna llamada "IMG_DIR" a los DataFrames
train_labels y test_labels, y llenamos esta columna con las imágenes
correspondientes utilizando la función id_to_path que definimos
anteriormente. Así tenemos las imágenes asociadas a los datos de los
Dataframes:</p>
</div>
<div class="cell code" id="5V26SHWfRr_F">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>train_data[<span class="st">&quot;IMG_DIR&quot;</span>] <span class="op">=</span> TRAIN_IMG_DIR</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>train_data[<span class="st">&quot;IMG_DIR&quot;</span>] <span class="op">=</span> train_data.<span class="bu">apply</span>(<span class="kw">lambda</span> x: id_to_path(x.ID, x.IMG_DIR),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                                             axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>test_data[<span class="st">&quot;IMG_DIR&quot;</span>] <span class="op">=</span> TEST_IMG_DIR</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>test_data[<span class="st">&quot;IMG_DIR&quot;</span>] <span class="op">=</span> test_data.<span class="bu">apply</span>(<span class="kw">lambda</span> x: id_to_path(x.ID, x.IMG_DIR),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                                           axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="d_ByHys53dfV" data-outputId="2dcbe5d4-8dee-410f-bdda-28165062705e">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>test_data.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="21">

  <div id="df-bca597d3-9d71-47fe-8775-6bab226b58aa" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>DR</th>
      <th>MH</th>
      <th>Etiquetas</th>
      <th>Clase</th>
      <th>IMG_DIR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>Enfermo</td>
      <td>/content/drive/MyDrive/Trabajo_Retina/Test_Set...</td>
    </tr>
    <tr>
      <th>103</th>
      <td>104</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Enfermo</td>
      <td>/content/drive/MyDrive/Trabajo_Retina/Test_Set...</td>
    </tr>
    <tr>
      <th>38</th>
      <td>39</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
      <td>/content/drive/MyDrive/Trabajo_Retina/Test_Set...</td>
    </tr>
    <tr>
      <th>475</th>
      <td>476</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
      <td>/content/drive/MyDrive/Trabajo_Retina/Test_Set...</td>
    </tr>
    <tr>
      <th>561</th>
      <td>562</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>No enfermo</td>
      <td>/content/drive/MyDrive/Trabajo_Retina/Test_Set...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-bca597d3-9d71-47fe-8775-6bab226b58aa')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-bca597d3-9d71-47fe-8775-6bab226b58aa button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-bca597d3-9d71-47fe-8775-6bab226b58aa');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-3d3779d4-60d9-40ba-be44-eddb3f2d1aea">
  <button class="colab-df-quickchart" onclick="quickchart('df-3d3779d4-60d9-40ba-be44-eddb3f2d1aea')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-3d3779d4-60d9-40ba-be44-eddb3f2d1aea button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>

</div>
</div>
<div class="cell code" id="3PyU_MMd4Ofl">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optativo: Descargar el archivo csv en formato xlsx para comprobar que cada imagen está bien asociada a su indentificador</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>train_data.to_excel(<span class="st">&#39;/content/modified_traindataframe.xlsx&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>test_data.to_excel(<span class="st">&#39;/content/modified_testdataframe.xlsx&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="0ovUi4TSIwpe">
<p>A continuación vamos a ver la distribución de las clases en nuestro
conjunto de datos de train y test para ver que no haya desembalance:</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="Wk12CXqUHvF9" data-outputId="c042d464-c880-433d-ea99-03ab934435c8">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Contar el número de 0 y 1 en la columna &#39;Enfermo&#39; del conjunto de train</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>enfermo_counts <span class="op">=</span> train_data[<span class="st">&#39;Etiquetas&#39;</span>].value_counts()</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar el resultado</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Número total de No Enfermos en train:&quot;</span>, enfermo_counts[<span class="dv">0</span>])</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Número total de Enfermos en train:&quot;</span>, enfermo_counts[<span class="dv">1</span>])</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Número total de No Enfermos en train: 130
Número total de Enfermos en train: 70
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="AgGRqjIxId49" data-outputId="e229c37d-083b-47db-d55f-db6f43df8e8e">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>enfermo_counts <span class="op">=</span> test_data[<span class="st">&#39;Etiquetas&#39;</span>].value_counts()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Número total de No Enfermos en test:&quot;</span>, enfermo_counts[<span class="dv">0</span>])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Número total de Enfermos en test:&quot;</span>, enfermo_counts[<span class="dv">1</span>])</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Número total de No Enfermos en test: 39
Número total de Enfermos en test: 21
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:927}"
id="4xJgKf2FKvrs" data-outputId="85c73f1f-04a6-48de-ab0c-c7b5838e2782">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_distribution(labels, title):</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    class_mapping <span class="op">=</span> {<span class="dv">0</span>: <span class="st">&#39;No Enfermo&#39;</span>, <span class="dv">1</span>: <span class="st">&#39;Enfermo&#39;</span>}</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    labels[<span class="st">&#39;Clase&#39;</span>] <span class="op">=</span> labels[<span class="st">&#39;Etiquetas&#39;</span>].<span class="bu">map</span>(class_mapping)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> sns.countplot(y<span class="op">=</span><span class="st">&#39;Clase&#39;</span>, data<span class="op">=</span>labels, orient<span class="op">=</span><span class="st">&#39;h&#39;</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ajustar límites del eje x</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(<span class="dv">0</span>, <span class="dv">200</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f&#39;</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss"> - Distribución de Frecuencias - Enfermo vs No Enfermo&#39;</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;Número de Imágenes/Pacientes&#39;</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;Clase&#39;</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar la distribución de frecuencias para el conjunto de entrenamiento</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>plot_distribution(train_data, <span class="st">&#39;TRAIN&#39;</span>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar la distribución de frecuencias para el conjunto de prueba</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>plot_distribution(test_data, <span class="st">&#39;TEST&#39;</span>)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_e313a08259a04e75a6ad94e007493727/278f9eb77e0c2698f222222271b07bf5cdafa448.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_e313a08259a04e75a6ad94e007493727/432bc34b90234af5bfd9f94f7e87b11efa8f973e.png" /></p>
</div>
</div>
<div class="cell markdown" id="a4CKzkN1t0Pg">
<p><strong>DEFINICIÓN DE CLASES PARA EL ENTRENAMIENTO Y EVALUACIÓN DEL
MODELO</strong></p>
</div>
<div class="cell code" id="xkhzgHjMl4qd">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.preprocessing.image <span class="im">import</span> ImageDataGenerator</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code></pre></div>
</div>
<div class="cell markdown" id="LcjFwEdqt-G3">
<p>Este bloque de código define una clase ImagePreprocessor que se
utiliza para preprocesar imágenes y crear generadores de datos antes de
alimentarlas al modelo.</p>
</div>
<div class="cell code" id="OWct73FPRsHx">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImagePreprocessor:</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Usar el método __init__ para definir los parámetros de inicialización</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, cnn_variant, input_size, labels):  <span class="co">#HEMOS QUITADO VAL</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cnn_variant <span class="op">=</span> cnn_variant  <span class="co">#Almacena la variante de red neuronal convolucional que se usará para el preprocesamiento: MobileNetV2,Resnet50,etc...</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_gen <span class="op">=</span> <span class="va">None</span>   <span class="co">#almacenar generadores de train y test (determinados por la función de abajo)</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test_gen <span class="op">=</span> <span class="va">None</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_size <span class="op">=</span> input_size <span class="co">#tamaño de entrada deseado para las imágenes</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> labels <span class="co">#etiquetas que se utilizarán durante el entrenamiento</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Método para crear generadores de imagen para el conjunto train y test</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_generators(<span class="va">self</span>):</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_gen <span class="op">=</span> tf.keras.preprocessing.image.ImageDataGenerator(</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>            preprocessing_function<span class="op">=</span><span class="va">self</span>.cnn_variant.preprocess_input            <span class="co">#se puede añadir rotaciones y otras cosas</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test_gen <span class="op">=</span> tf.keras.preprocessing.image.ImageDataGenerator(</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>            preprocessing_function<span class="op">=</span><span class="va">self</span>.cnn_variant.preprocess_input</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modifica el método preprocess en tu clase ImagePreprocessor</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> preprocess(<span class="va">self</span>):</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        train_images <span class="op">=</span> <span class="va">self</span>.train_gen.flow_from_dataframe(</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        dataframe<span class="op">=</span>train_data,</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        x_col<span class="op">=</span><span class="st">&quot;IMG_DIR&quot;</span>,</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>        y_col<span class="op">=</span> <span class="st">&quot;Clase&quot;</span>,</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        target_size<span class="op">=</span><span class="va">self</span>.input_size,  <span class="co"># Este será el tamaño al que se redimensionarán las imágenes</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>        color_mode<span class="op">=</span><span class="st">&#39;rgb&#39;</span>,</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        class_mode<span class="op">=</span><span class="st">&quot;binary&quot;</span>,</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>        test_images <span class="op">=</span> <span class="va">self</span>.test_gen.flow_from_dataframe(</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        dataframe<span class="op">=</span>test_data,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        x_col<span class="op">=</span><span class="st">&quot;IMG_DIR&quot;</span>,</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        y_col<span class="op">=</span> <span class="st">&quot;Clase&quot;</span>,</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        target_size<span class="op">=</span><span class="va">self</span>.input_size,  <span class="co"># Este será el tamaño al que se redimensionarán las imágenes</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>        color_mode<span class="op">=</span><span class="st">&#39;rgb&#39;</span>,</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>        class_mode<span class="op">=</span><span class="st">&quot;binary&quot;</span>,</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> train_images, test_images</span></code></pre></div>
</div>
<section
id="como-hemos-quitado-el-conjunto-de-validación-ver-si-es-necesario-crear-uno--voy-poniendo-de-donde-se-ha-quitado"
class="cell markdown" id="6_fhOkSVBbmo">
<h2>COMO HEMOS QUITADO EL CONJUNTO DE VALIDACIÓN, VER SI ES NECESARIO
CREAR UNO , VOY PONIENDO DE DONDE SE HA QUITADO</h2>
</section>
<div class="cell markdown" id="x5Oc0jwZvXqp">
<p><strong>1. Clase <code>ImagePreprocessor</code></strong>: Define una
clase llamada ImagePreprocessor. Los parámetros de inicialización
(<strong>init</strong>) incluyen la variante de CNN (cnn_variant), el
tamaño de entrada de la imagen (input_size), y las etiquetas (labels)
que se utilizarán para la clasificación.</p>
<p><strong>2. Método <code>create_generators</code></strong>: define un
método llamado create_generators que va crear 2 generadores de datos
(uno para train y otro para test) utilizando la variante de CNN
especificada. Estos generadores aplican una función de preprocesamiento
a las imágenes proporcionada por la variante de la red neuronal
convolucional. Estas funciones suelen estar diseñadas para preparar las
imágenes de acuerdo con los requisitos de entrada del modelo
preentrenado. Por ejemplo, los modelos preentrenados en ImageNet a
menudo requieren que las imágenes se normalicen de una manera
específica</p>
<p><strong>3. Método <code>preprocess</code></strong>: este módulo se
usa para vincular los DataFrames (train_data y test_data) a los
generadores creados anteriormente. Utiliza flow_from_dataframe de Keras,
especificando la columna que contiene las rutas de las imágenes (x_col),
las etiquetas (y_col), el tamaño de destino de las imágenes
(target_size), el modo de color (color_mode), el tamaño del lote
(batch_size), el modo de clase (class_mode), y si se deben mezclar las
muestras (shuffle). Finalmente, devuelve los generadores de imágenes
preprocesadas para entrenamiento y prueba de nuestro caso.</p>
</div>
<div class="cell markdown" id="ghLAgNM-ETdx">
<p>La siguiente clase encapsula el proceso de transferencia de
aprendizaje, marcando las capas no entrenables, agregando capas
adicionales y compilando y entrenando el modelo.</p>
</div>
<div class="cell code" id="1Tb9Wm-vRsPp">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TransferLearning:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Método de inicialización</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, train, model, classes : <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:       <span class="co">#QUITADO VAL</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train <span class="op">=</span> train <span class="co">#se refiere al conjunto de entrenamiento</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> <span class="va">None</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fine_tune_from <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_size <span class="op">=</span> (<span class="dv">200</span>,<span class="dv">200</span>,<span class="dv">3</span>)  <span class="co">#esto depende del modelo que estés usando !!! --&gt; EfficientNetB0</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classes <span class="op">=</span> classes</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mark_layers_non_trainable(<span class="va">self</span>):</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> <span class="va">self</span>.model.layers:</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>            layer.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_final_layer(<span class="va">self</span>):</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x <span class="op">=</span> Flatten()(<span class="va">self</span>.model.output)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.x <span class="op">=</span> Dense(<span class="dv">1000</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)(<span class="va">self</span>.x)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predictions <span class="op">=</span> Dense(<span class="dv">1</span>, activation <span class="op">=</span> <span class="st">&#39;sigmoid&#39;</span>)(<span class="va">self</span>.x)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compile_model(<span class="va">self</span>):</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> Model(inputs <span class="op">=</span> <span class="va">self</span>.model.<span class="bu">input</span>,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>                           outputs <span class="op">=</span> <span class="va">self</span>.predictions)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>,</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>                           loss<span class="op">=</span><span class="st">&quot;binary_crossentropy&quot;</span>,</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>                           metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>,</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>                                    tf.keras.metrics.AUC(name<span class="op">=</span><span class="st">&quot;auc&quot;</span>,from_logits<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>                                    tf.keras.metrics.FalseNegatives(name<span class="op">=</span><span class="st">&quot;false_negatives&quot;</span>),</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>                                    tf.keras.metrics.FalsePositives(name<span class="op">=</span><span class="st">&quot;false_positives&quot;</span>),</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>                                    tf.keras.metrics.Precision(name<span class="op">=</span><span class="st">&quot;precision&quot;</span>),</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>                                    tf.keras.metrics.Recall(name<span class="op">=</span><span class="st">&quot;recall&quot;</span>)])</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> train_model(<span class="va">self</span>):</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> <span class="va">self</span>.model.fit(<span class="va">self</span>.train,</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>                                  batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>                                  epochs<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>                                  callbacks<span class="op">=</span>[</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>                                    tf.keras.callbacks.EarlyStopping(</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>                                        monitor<span class="op">=</span><span class="st">&#39;loss&#39;</span>,  <span class="co"># Cambiado a &#39;loss&#39; para monitorizar la pérdida de entrenamiento por haber QUITADO CONJUNTO VAL</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>                                        patience<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>                                        restore_best_weights<span class="op">=</span><span class="va">True</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>                                 ])</span></code></pre></div>
</div>
<div class="cell markdown" id="1LwyrItiDJTz">
<p><strong>1)
<code>__init__(self, train, model, classes)</code></strong>: este es el
método de inicialización de la clase. Toma cuatro parámetros: train (el
generador de imágenes para el conjunto de entrenamiento), model (el
modelo preentrenado que se utilizará como base) y classes (el número de
clases en la tarea de clasificación).</p>
<p><strong>2) <code>mark_layers_non_trainable(self)</code></strong>:
este método marca todas las capas del modelo preentrenado como no
entrenables. Esto es común cuando estás realizando transferencia de
aprendizaje y solo deseas entrenar las capas añadidas recientemente.</p>
<p><strong>3) <code>add_final_layer(self)</code></strong>: este método
agrega capas adicionales al modelo después de las capas existentes. En
este caso, se añade una capa de aplanamiento (Flatten()), seguida de una
capa densa con activación ReLU y otra capa densa de salida con
activación sigmoide ya que estamos realizando una clasificación
binaria.</p>
<p><strong>4) <code>compile_model(self)</code></strong>: este método
compila el modelo. Combina el modelo preentrenado con las nuevas capas
añadidas y configura la función de pérdida, el optimizador y las
métricas para el entrenamiento.</p>
<p><strong>5) <code>train_model(self)</code></strong>: este método
entrena el modelo utilizando los generadores de imágenes de
entrenamiento y validación proporcionados. Utiliza el método fit de
Keras y define algunas métricas específicas para el seguimiento del
rendimiento durante el entrenamiento.</p>
</div>
<div class="cell markdown" id="RHe_vX0qB4S1">
<p>Se define una función llamada experiment_model que es la que va a
realizar el entrenamiento del modelo utilizando transfer learning.
Encapsula el proceso completo de preparación de datos, configuración del
modelo, entrenamiento y devolución de resultados:</p>
</div>
<div class="cell code" id="Tdc_Q3LjRsWe">
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> experiment_model(preprocessing_function, model, input_size : <span class="bu">tuple</span>, target_label : <span class="bu">str</span>):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ImagePreprocessor(preprocessing_function,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                                     input_size,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                                     target_label)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    preprocessor.create_generators()</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    train, test <span class="op">=</span> preprocessor.preprocess()</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    modelbuilder <span class="op">=</span> TransferLearning(train, model, classes<span class="op">=</span><span class="dv">2</span>)      <span class="co">#hemos quitado de aqui el val</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    modelbuilder.mark_layers_non_trainable()</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    modelbuilder.add_final_layer()</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    modelbuilder.compile_model()</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    modelbuilder.train_model()</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelbuilder.model, modelbuilder.history, test  <span class="co">#La función devuelve el modelo entrenado, el historial del entrenamiento y el conjunto de prueba.</span></span></code></pre></div>
</div>
<div class="cell markdown" id="9DJqv7sqwbvV">
<p>La siguiente clase que se va a definir es la clase ThresholdTuner que
se va a encargar de ajustar y encontrar el umbral óptimo para la
clasificación binaria utilizando curvas de precisión-recall (PR).</p>
<p>Las salidas del modelo generalmente se interpretan como la
probabilidad de pertenecer a una clase u otra. La salida del modelo se
puede interpretar como un valor de probabilidad en el rango de 0 a
1.</p>
<p>Si el valor es cercano a 0, se interpreta como una alta probabilidad
de pertenecer a la clase negativa ("no estar enfermo"). Si el valor es
cercano a 1, se interpreta como una alta probabilidad de pertenecer a la
clase positiva ("estar enfermo"). Para convertir estas probabilidades en
predicciones binarias, necesitas establecer un umbral (threshold). Si la
probabilidad predicha por el modelo es mayor o igual al umbral,
clasificas la instancia como positiva; de lo contrario, la clasificas
como negativa</p>
</div>
<div class="cell code" id="mlrmtCroSqk_">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThresholdTuner:</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, test):</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test <span class="op">=</span> test</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predictions_raw <span class="op">=</span> <span class="va">None</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.f1_scores <span class="op">=</span> []</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> <span class="va">None</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __predict_test(<span class="va">self</span>):</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predictions_raw <span class="op">=</span> <span class="va">self</span>.model.predict(<span class="va">self</span>.test).flatten()</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __clip_logits(<span class="va">self</span>, t : <span class="bu">float</span>, p : <span class="bu">float</span>):</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="op">&gt;=</span> t:</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __plot_raw_logits(<span class="va">self</span>, ax):</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>        ax.hist(<span class="va">self</span>.predictions_raw, edgecolor<span class="op">=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        ax.title.set_text(<span class="st">&quot;Distribution of logits at final layer&quot;</span>)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">&quot;Logits&quot;</span>)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">&quot;Frequency&quot;</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __tune_threshold_pr_curve(<span class="va">self</span>, ax):</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>        precision, recall, thresholds <span class="op">=</span> precision_recall_curve(<span class="va">self</span>.test.labels, <span class="va">self</span>.predictions_raw)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        fscore <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span> np.argmax(fscore)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Best Threshold=</span><span class="sc">%f</span><span class="st">, F-score=</span><span class="sc">%.3f</span><span class="st"> using PR Curve&#39;</span> <span class="op">%</span> (thresholds[ix], fscore[ix]))</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> thresholds[ix]</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>        no_skill <span class="op">=</span> np.count_nonzero(<span class="va">self</span>.test.labels <span class="op">==</span> <span class="dv">1</span>) <span class="op">/</span> <span class="bu">len</span>(<span class="va">self</span>.test.labels)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>        ax.plot([<span class="dv">0</span>,<span class="dv">1</span>], [no_skill,no_skill], linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, label<span class="op">=</span><span class="st">&#39;No Skill&#39;</span>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        ax.plot(recall, precision, marker<span class="op">=</span><span class="st">&#39;.&#39;</span>, label<span class="op">=</span><span class="st">&#39;Logistic&#39;</span>)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>        ax.scatter(recall[ix], precision[ix], marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>, label<span class="op">=</span><span class="st">&#39;Best&#39;</span>)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>        ax.title.set_text(<span class="st">&quot;PR Curve&quot;</span>)</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">&#39;Recall&#39;</span>)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">&#39;Precision&#39;</span>)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_optimal_thresholds(<span class="va">self</span>):</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__predict_test()</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>        columns <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>        fig, axs <span class="op">=</span> plt.subplots(rows, columns,figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__plot_raw_logits(axs[<span class="dv">0</span>])</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__tune_threshold_pr_curve(axs[<span class="dv">1</span>])</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(<span class="st">&quot;Threshold Moving for Binary Classifier&quot;</span>)</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>        plt.subplots_adjust(bottom<span class="op">=</span><span class="fl">0.1</span>, top<span class="op">=</span><span class="fl">0.9</span>, hspace<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>        plt.show()</span></code></pre></div>
</div>
<div class="cell markdown" id="snPSxKshnnX2">
<p><strong>BALANCEO DE CLASES</strong></p>
<p>El balanceo de clases es importante en algoritmos de clasificación
cuando las clases en los datos de entrenamiento (train_data) no tienen
una distribución uniforme. Es decir, unas clases van a estar
sobrerrepresentadas en comparación con otras. De forma que el modelo se
va a ver influenciado y sesgado hacia las clases mayoritarias. Esto nos
afecta especialmente, porque lo que se pretende es clasificar lo mejor
posible y que la red no posea un rendimiento deficiente en la
clasificación de clases minoritarias.</p>
<p>Si no utilizamos el modelo de balanceo de clases, ocurre que el
accuracy en la salida de la CNN es de 0.9 o incluso 1. Esto no quiere
decir que la red tenga un rendimiento espectacular y clasifique de una
forma perfecta o casi perfecta. Sino que el modelo se está viendo
desplazado a la clasificación de una sola clase (que es mayoritaria en
este caso). Lo óptimo para un algoritmo de clasificación es tener un
accuracy de 0.7 en los mejores casos, por lo que, vamos a balancear las
clases y luego ajustar los parámetros en función de nuestras
necesidades.</p>
</div>
<div class="cell code" id="gHrDcKyC17Zq">
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FocalLoss(nn.Module):</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, gamma<span class="op">=</span><span class="dv">0</span>, alpha<span class="op">=</span><span class="va">None</span>, size_average<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(FocalLoss, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gamma <span class="op">=</span> gamma</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.alpha <span class="op">=</span> alpha</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(alpha, (<span class="bu">float</span>, <span class="bu">int</span>)):</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.alpha <span class="op">=</span> torch.Tensor([alpha, <span class="dv">1</span> <span class="op">-</span> alpha])</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(alpha, <span class="bu">list</span>):</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.alpha <span class="op">=</span> torch.Tensor(alpha)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size_average <span class="op">=</span> size_average</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>, target):</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">input</span>.dim() <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span> <span class="op">=</span> <span class="bu">input</span>.view(<span class="bu">input</span>.size(<span class="dv">0</span>), <span class="bu">input</span>.size(<span class="dv">1</span>), <span class="op">-</span><span class="dv">1</span>)  <span class="co"># N,C,H,W =&gt; N,C,H*W</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span> <span class="op">=</span> <span class="bu">input</span>.transpose(<span class="dv">1</span>, <span class="dv">2</span>)  <span class="co"># N,C,H*W =&gt; N,H*W,C</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span> <span class="op">=</span> <span class="bu">input</span>.contiguous().view(<span class="op">-</span><span class="dv">1</span>, <span class="bu">input</span>.size(<span class="dv">2</span>))  <span class="co"># N,H*W,C =&gt; N*H*W,C</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> target.view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        logpt <span class="op">=</span> F.log_softmax(<span class="bu">input</span>, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        logpt <span class="op">=</span> logpt.gather(<span class="dv">1</span>, target)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        logpt <span class="op">=</span> logpt.view(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        pt <span class="op">=</span> logpt.exp()</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.alpha <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.alpha.<span class="bu">type</span>() <span class="op">!=</span> <span class="bu">input</span>.data.<span class="bu">type</span>():</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.alpha <span class="op">=</span> <span class="va">self</span>.alpha.type_as(<span class="bu">input</span>.data)</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>            at <span class="op">=</span> <span class="va">self</span>.alpha.gather(<span class="dv">0</span>, target.view(<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>            logpt <span class="op">=</span> logpt <span class="op">*</span> at</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> pt) <span class="op">**</span> <span class="va">self</span>.gamma <span class="op">*</span> logpt</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.size_average:</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> loss.mean()</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> loss.<span class="bu">sum</span>()</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Usar Focal Loss con alpha=0.7</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> FocalLoss(gamma<span class="op">=</span><span class="dv">0</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="mmPqBWQBqu6A">
<p>Los parámetros específicos de la Focal Loss que se pueden ajustar
según nuestras necesidades son gamma y alpha.</p>
<ul>
<li><p>gamma: Es un parámetro que controla la cantidad de enfoque que se
aplica a las clases mal clasificadas. Un valor más alto de gamma le dará
más enfoque a las clases mal clasificadas. Los valores más comunes están
en un rango de 0 a 5.</p></li>
<li><p>alpha: Este parámetro permite ajustar los pesos de las clases
para abordar el desbalance de clases. Si no se proporciona un valor para
alpha, se usará el mismo peso para todas las clases. Si se proporciona
un solo valor, se usará ese valor como peso para la clase positiva, y el
peso para la clase negativa será 1 - alpha. Si se proporciona una lista
de valores, estos se usarán como pesos para cada clase. Se puede
experimentar con diferentes valores para alpha para encontrar el
equilibrio adecuado para el conjunto de nuestros datos. Hay que tener
cuidado con los valores de alpha, porque serán menores que 1 siempre
(0.7 significa que la clase positiva tiene un peso del 70%, y la clase
negativa tiene un peso del 30%, etc)</p></li>
</ul>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="HJW5WbkFSqux" data-outputId="9ec2b268-8574-4e41-d1bd-72f081ddde2a">
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>efficientnet, history, efficientnet_test <span class="op">=</span> experiment_model(cnns.efficientnet,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>                                                            cnns.EfficientNetB0(include_top<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                                                                                input_shape<span class="op">=</span>(<span class="dv">200</span>,<span class="dv">200</span>,<span class="dv">3</span>)),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                                                            (<span class="dv">200</span>,<span class="dv">200</span>), <span class="st">&quot;Clase&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Downloading data from https://storage.googleapis.com/keras-applications/efficientnetb0_notop.h5
16705208/16705208 [==============================] - 0s 0us/step
Found 200 validated image filenames belonging to 2 classes.
Found 60 validated image filenames belonging to 2 classes.
Epoch 1/15
20/20 [==============================] - 91s 4s/step - loss: 10.8233 - accuracy: 0.7050 - auc: 0.7218 - false_negatives: 32.0000 - false_positives: 27.0000 - precision: 0.7840 - recall: 0.7538
Epoch 2/15
20/20 [==============================] - 25s 1s/step - loss: 1.7627 - accuracy: 0.8150 - auc: 0.8353 - false_negatives: 20.0000 - false_positives: 17.0000 - precision: 0.8661 - recall: 0.8462
Epoch 3/15
20/20 [==============================] - 23s 1s/step - loss: 0.5443 - accuracy: 0.8750 - auc: 0.9042 - false_negatives: 12.0000 - false_positives: 13.0000 - precision: 0.9008 - recall: 0.9077
Epoch 4/15
20/20 [==============================] - 26s 1s/step - loss: 0.2355 - accuracy: 0.9200 - auc: 0.9705 - false_negatives: 10.0000 - false_positives: 6.0000 - precision: 0.9524 - recall: 0.9231
Epoch 5/15
20/20 [==============================] - 25s 1s/step - loss: 0.3358 - accuracy: 0.9250 - auc: 0.9598 - false_negatives: 7.0000 - false_positives: 8.0000 - precision: 0.9389 - recall: 0.9462
Epoch 6/15
20/20 [==============================] - 25s 1s/step - loss: 0.2103 - accuracy: 0.9350 - auc: 0.9805 - false_negatives: 6.0000 - false_positives: 7.0000 - precision: 0.9466 - recall: 0.9538
Epoch 7/15
20/20 [==============================] - 23s 1s/step - loss: 0.1335 - accuracy: 0.9800 - auc: 0.9871 - false_negatives: 2.0000 - false_positives: 2.0000 - precision: 0.9846 - recall: 0.9846
Epoch 8/15
20/20 [==============================] - 25s 1s/step - loss: 0.0845 - accuracy: 0.9750 - auc: 0.9941 - false_negatives: 3.0000 - false_positives: 2.0000 - precision: 0.9845 - recall: 0.9769
Epoch 9/15
20/20 [==============================] - 23s 1s/step - loss: 0.0224 - accuracy: 0.9900 - auc: 0.9998 - false_negatives: 1.0000 - false_positives: 1.0000 - precision: 0.9923 - recall: 0.9923
Epoch 10/15
20/20 [==============================] - 25s 1s/step - loss: 0.0295 - accuracy: 0.9950 - auc: 0.9998 - false_negatives: 0.0000e+00 - false_positives: 1.0000 - precision: 0.9924 - recall: 1.0000
Epoch 11/15
20/20 [==============================] - 23s 1s/step - loss: 0.7656 - accuracy: 0.8700 - auc: 0.9183 - false_negatives: 12.0000 - false_positives: 14.0000 - precision: 0.8939 - recall: 0.9077
Epoch 12/15
20/20 [==============================] - 25s 1s/step - loss: 0.8558 - accuracy: 0.9100 - auc: 0.9347 - false_negatives: 9.0000 - false_positives: 9.0000 - precision: 0.9308 - recall: 0.9308
Epoch 13/15
20/20 [==============================] - 23s 1s/step - loss: 0.5603 - accuracy: 0.9100 - auc: 0.9391 - false_negatives: 11.0000 - false_positives: 7.0000 - precision: 0.9444 - recall: 0.9154
Epoch 14/15
20/20 [==============================] - 26s 1s/step - loss: 0.7122 - accuracy: 0.9300 - auc: 0.9418 - false_negatives: 6.0000 - false_positives: 8.0000 - precision: 0.9394 - recall: 0.9538
</code></pre>
</div>
</div>
<div class="cell code" id="5-VfUoIpSqyX">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> ThresholdTuner(efficientnet, efficientnet_test)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:555}"
id="fOBa8Fl1Sq1L" data-outputId="fe2e9433-69f6-4a36-9ff2-33ed3f29a325">
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>tuner.find_optimal_thresholds()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>6/6 [==============================] - 27s 5s/step
Best Threshold=0.000000, F-score=0.857 using PR Curve
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_e313a08259a04e75a6ad94e007493727/d65921e8f2d1c63f4cfe4635ea7970d1e86ee3da.png" /></p>
</div>
</div>
<div class="cell markdown" id="NEBR53p4vdZT">
<p><strong>EVALUACIÓN DE MODELO</strong></p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:390}"
id="4spzYkal_svi" data-outputId="5188c476-71c3-4a11-8309-ddd5a79b306c">
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#CÓDIGO 1: Los parámetros se tienen que modificar para que no dé error.</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> transforms</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelEvaluator:</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, test, criterion):</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test <span class="op">=</span> test</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.criterion <span class="op">=</span> criterion</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate(<span class="va">self</span>):</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        all_predictions <span class="op">=</span> []</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        all_labels <span class="op">=</span> []</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> inputs, labels <span class="kw">in</span> <span class="va">self</span>.test:</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> <span class="va">self</span>.model(inputs)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> <span class="va">self</span>.criterion(outputs, labels)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>                predictions <span class="op">=</span> torch.argmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>                all_predictions.extend(predictions.cpu().numpy())</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>                all_labels.extend(labels.cpu().numpy())</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> accuracy_score(all_labels, all_predictions)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>        classification_report_result <span class="op">=</span> classification_report(all_labels, all_predictions)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>        conf_matrix <span class="op">=</span> confusion_matrix(all_labels, all_predictions)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> accuracy, classification_report_result, conf_matrix</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visualize_confusion_matrix(<span class="va">self</span>, conf_matrix):</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>        sns.heatmap(conf_matrix, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&quot;d&quot;</span>, cmap<span class="op">=</span><span class="st">&quot;Blues&quot;</span>,</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>                    xticklabels<span class="op">=</span>[<span class="st">&quot;Class 0&quot;</span>, <span class="st">&quot;Class 1&quot;</span>], yticklabels<span class="op">=</span>[<span class="st">&quot;Class 0&quot;</span>, <span class="st">&quot;Class 1&quot;</span>])</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">&#39;Confusion Matrix&#39;</span>)</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">&#39;True&#39;</span>)</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Uso del ModelEvaluator con experiment_model</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>efficientnet, history, efficientnet_test <span class="op">=</span> experiment_model(  <span class="co">#my_model, history, test_data</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>                                           preprocessing_function<span class="op">=</span>transforms.Compose([transforms.ToTensor()]),</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>                                           model<span class="op">=</span>efficientnet,  <span class="co"># Reemplaza con tu modelo</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>                                           input_size<span class="op">=</span>(<span class="dv">200</span>, <span class="dv">200</span>),</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>                                           target_label<span class="op">=</span><span class="st">&quot;Clase&quot;</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>                                           )</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>my_test_loader <span class="op">=</span> DataLoader(test_data, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>my_criterion <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>my_model_evaluator <span class="op">=</span> ModelEvaluator(my_model, my_test_loader, my_criterion)</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>accuracy, classification_report_result, conf_matrix <span class="op">=</span> my_model_evaluator.evaluate()</span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Classification Report:</span><span class="ch">\n</span><span class="sc">{</span>classification_report_result<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Confusion Matrix:</span><span class="ch">\n</span><span class="sc">{</span>conf_matrix<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>my_model_evaluator.visualize_confusion_matrix(conf_matrix)</span></code></pre></div>
<div class="output error" data-ename="AttributeError"
data-evalue="ignored">
<pre><code>---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
&lt;ipython-input-68-c3e01c935411&gt; in &lt;cell line: 39&gt;()
     37 
     38 # Uso del ModelEvaluator con experiment_model
---&gt; 39 efficientnet, history, efficientnet_test = experiment_model(  #my_model, history, test_data 
     40                                            preprocessing_function=transforms.Compose([transforms.ToTensor()]),
     41                                            model=efficientnet,  # Reemplaza con tu modelo

&lt;ipython-input-60-f25bc2c0c725&gt; in experiment_model(preprocessing_function, model, input_size, target_label)
     41                                      input_size,
     42                                      target_label)
---&gt; 43     preprocessor.create_generators()
     44     train, test = preprocessor.preprocess()
     45     modelbuilder = TransferLearning(train, model, classes=2)      #hemos quitado de aqui el val

&lt;ipython-input-27-94097d306d0b&gt; in create_generators(self)
     11     def create_generators(self):
     12         self.train_gen = tf.keras.preprocessing.image.ImageDataGenerator(
---&gt; 13             preprocessing_function=self.cnn_variant.preprocess_input            #se puede añadir rotaciones y otras cosas
     14         )
     15 

AttributeError: &#39;Compose&#39; object has no attribute &#39;preprocess_input&#39;
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:366}"
id="hGS5eqEx93B5" data-outputId="f85f374a-5cc7-4bfa-fadc-7f7a48beeb83">
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Código 2: Los parámetros se tienen que modificar para que no dé error.</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, classification_report, confusion_matrix</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelEvaluator:</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model, test, criterion):</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.test_loader <span class="op">=</span> test</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.criterion <span class="op">=</span> criterion</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> inputs, labels <span class="kw">in</span> <span class="va">self</span>.test_loader:</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>                outputs <span class="op">=</span> model(model_image.to(device))</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>                end_time <span class="op">=</span> time.time()</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> <span class="va">self</span>.criterion(outputs, etiquetas)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>                predictions <span class="op">=</span> torch.argmax(outputs, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>                all_predictions.extend(predictions.cpu().numpy())</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>                all_labels.extend(labels.cpu().numpy())</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> accuracy_score(all_labels, all_predictions)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>        classification_report_result <span class="op">=</span> classification_report(all_labels, all_predictions)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>        conf_matrix <span class="op">=</span> confusion_matrix(all_labels, all_predictions)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> accuracy, classification_report_result, conf_matrix</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visualize_confusion_matrix(<span class="va">self</span>, conf_matrix):</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>        sns.heatmap(conf_matrix, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&quot;d&quot;</span>, cmap<span class="op">=</span><span class="st">&quot;Blues&quot;</span>,</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>                    xticklabels<span class="op">=</span>[<span class="st">&quot;Class 0&quot;</span>, <span class="st">&quot;Class 1&quot;</span>], yticklabels<span class="op">=</span>[<span class="st">&quot;Class 0&quot;</span>, <span class="st">&quot;Class 1&quot;</span>])</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">&#39;Confusion Matrix&#39;</span>)</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">&#39;Predicted&#39;</span>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">&#39;True&#39;</span>)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Uso del ModelEvaluator</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>my_model_evaluator <span class="op">=</span> ModelEvaluator(experiment_model, test_data, criterion)</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>accuracy, classification_report_result, conf_matrix <span class="op">=</span> my_model_evaluator.evaluate()</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Classification Report:</span><span class="ch">\n</span><span class="sc">{</span>classification_report_result<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Confusion Matrix:</span><span class="ch">\n</span><span class="sc">{</span>conf_matrix<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>my_model_evaluator.visualize_confusion_matrix(conf_matrix)</span></code></pre></div>
<div class="output error" data-ename="NameError" data-evalue="ignored">
<pre><code>---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
&lt;ipython-input-65-c5b4998071e8&gt; in &lt;cell line: 37&gt;()
     35 
     36 # Uso del ModelEvaluator
---&gt; 37 my_model_evaluator = ModelEvaluator(experiment_model, test_data, criterion)
     38 accuracy, classification_report_result, conf_matrix = my_model_evaluator.evaluate()
     39 

&lt;ipython-input-65-c5b4998071e8&gt; in __init__(self, model, test, criterion)
     11         with torch.no_grad():
     12             for inputs, labels in self.test_loader:
---&gt; 13                 outputs = model(model_image.to(device))
     14                 end_time = time.time()
     15                 loss = self.criterion(outputs, etiquetas)

NameError: name &#39;model_image&#39; is not defined
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:175}"
id="R9_TBqOkTGt4" data-outputId="aa2b97e7-65a5-40cb-c9cc-4f5d4e6c14ab">
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>me <span class="op">=</span> ModelEvaluator(history, [<span class="st">&quot;No Enfermo&quot;</span>, <span class="st">&quot;Enfermo&quot;</span>], efficientnet, efficientnet_test, tuner.threshold)</span></code></pre></div>
<div class="output error" data-ename="NameError" data-evalue="ignored">
<pre><code>---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
&lt;ipython-input-47-071c64f8746b&gt; in &lt;cell line: 1&gt;()
----&gt; 1 me = ModelEvaluator(history, [&quot;No Enfermo&quot;, &quot;Enfermo&quot;], efficientnet, efficientnet_test, tuner.threshold)

NameError: name &#39;ModelEvaluator&#39; is not defined
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:193}"
id="jNu3jqnbTH-2" data-outputId="eb585d10-3732-49de-c8d5-310b920dc1f1">
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>me.training_history()</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>me.predict()</span></code></pre></div>
<div class="output error" data-ename="NameError" data-evalue="ignored">
<pre><code>---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
&lt;ipython-input-281-d59523e7805b&gt; in &lt;cell line: 1&gt;()
----&gt; 1 me.training_history()
      2 me.predict()

NameError: name &#39;me&#39; is not defined
</code></pre>
</div>
</div>
<div class="cell code" id="LXoR8wV0Sq3k">
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>me.class_report()</span></code></pre></div>
</div>
<div class="cell code" id="_dgUeDCxTRZK">
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dr[<span class="st">&quot;EfficientNetB0&quot;</span>] <span class="op">=</span> {<span class="st">&quot;Predictions&quot;</span>: tuner.predictions_raw.tolist(),</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Threshold&quot;</span>: <span class="bu">float</span>(tuner.threshold),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Ground Truth&quot;</span>: tuner.test.labels,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;History&quot;</span>: history.history</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>                       }</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co"># with open(&quot;/kaggle/working/DR.json&quot;, &#39;w&#39;) as fp:</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     json.dump(dr, fp)</span></span></code></pre></div>
</div>
<div class="cell code" id="5wKJmzsATRh4">
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>model, history, test <span class="op">=</span> experiment_model(cnns.resnet,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                                        cnns.ResNet152(include_top<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                                                            input_shape<span class="op">=</span>(<span class="dv">200</span>,<span class="dv">200</span>,<span class="dv">3</span>)),</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                                        (<span class="dv">200</span>,<span class="dv">200</span>), <span class="st">&quot;DR&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="YYVJ0fieTRpe">
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> ThresholdTuner(model, test)</span></code></pre></div>
</div>
<div class="cell code" id="6OyPIhUhTel9">
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>tuner.find_optimal_thresholds()</span></code></pre></div>
</div>
<div class="cell code" id="fgZ4hkpfTerN">
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>me <span class="op">=</span> ModelEvaluator(history, [<span class="st">&quot;Not Infected&quot;</span>, <span class="st">&quot;Infected&quot;</span>], model, test, tuner.threshold)</span></code></pre></div>
</div>
<div class="cell code" id="X_wt0IrpTeu2">
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>me.training_history()</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>me.predict()</span></code></pre></div>
</div>
<div class="cell code" id="57K22PtmTex3">
<div class="sourceCode" id="cb63"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>me.class_report()</span></code></pre></div>
</div>
<div class="cell code" id="vN-VPQEPTyzO">
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>dr[<span class="st">&quot;ResNet152&quot;</span>] <span class="op">=</span> {<span class="st">&quot;Predictions&quot;</span>: tuner.predictions_raw.tolist(),</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;Threshold&quot;</span>: <span class="bu">float</span>(tuner.threshold),</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;Ground Truth&quot;</span> : tuner.test.labels,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;History&quot;</span> : history.history</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                   }</span></code></pre></div>
</div>
<div class="cell code" id="FSztai0CTy4d">
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with open(&quot;/kaggle/working/DR.json&quot;, &#39;w&#39;) as fp:</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     json.dump(dr, fp)</span></span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:893}"
id="CsIunfNATy7s" data-outputId="0d8ba911-0c3a-4e6c-f729-ea64257d9bef">
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>model, history, test <span class="op">=</span> experiment_model(cnns.vgg16,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                                        cnns.VGG16(include_top<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                                                   input_shape<span class="op">=</span>(<span class="dv">200</span>,<span class="dv">200</span>,<span class="dv">3</span>)),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                                        (<span class="dv">200</span>,<span class="dv">200</span>), <span class="st">&quot;DR&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/vgg16/vgg16_weights_tf_dim_ordering_tf_kernels_notop.h5
58889256/58889256 [==============================] - 0s 0us/step
Found 200 validated image filenames belonging to 2 classes.
Found 60 validated image filenames belonging to 2 classes.
Epoch 1/15
20/20 [==============================] - 28s 1s/step - loss: 44.7696 - accuracy: 0.6300 - auc: 0.6111 - false_negatives: 44.0000 - false_positives: 30.0000 - precision: 0.7414 - recall: 0.6615
Epoch 2/15
20/20 [==============================] - 25s 1s/step - loss: 4.0247 - accuracy: 0.8600 - auc: 0.8491 - false_negatives: 9.0000 - false_positives: 19.0000 - precision: 0.8643 - recall: 0.9308
Epoch 3/15
20/20 [==============================] - 24s 1s/step - loss: 1.0082 - accuracy: 0.9200 - auc: 0.9282 - false_negatives: 7.0000 - false_positives: 9.0000 - precision: 0.9318 - recall: 0.9462
Epoch 4/15
20/20 [==============================] - 26s 1s/step - loss: 0.7441 - accuracy: 0.9250 - auc: 0.9451 - false_negatives: 9.0000 - false_positives: 6.0000 - precision: 0.9528 - recall: 0.9308
Epoch 5/15
20/20 [==============================] - 24s 1s/step - loss: 0.3495 - accuracy: 0.9500 - auc: 0.9559 - false_negatives: 6.0000 - false_positives: 4.0000 - precision: 0.9688 - recall: 0.9538
Epoch 6/15
20/20 [==============================] - 26s 1s/step - loss: 0.2384 - accuracy: 0.9350 - auc: 0.9770 - false_negatives: 8.0000 - false_positives: 5.0000 - precision: 0.9606 - recall: 0.9385
Epoch 7/15
20/20 [==============================] - 24s 1s/step - loss: 0.3482 - accuracy: 0.9450 - auc: 0.9605 - false_negatives: 5.0000 - false_positives: 6.0000 - precision: 0.9542 - recall: 0.9615
Epoch 8/15
20/20 [==============================] - 24s 1s/step - loss: 0.0284 - accuracy: 0.9950 - auc: 0.9999 - false_negatives: 0.0000e+00 - false_positives: 1.0000 - precision: 0.9924 - recall: 1.0000
Epoch 9/15
20/20 [==============================] - 26s 1s/step - loss: 2.4718e-05 - accuracy: 1.0000 - auc: 1.0000 - false_negatives: 0.0000e+00 - false_positives: 0.0000e+00 - precision: 1.0000 - recall: 1.0000
Epoch 10/15
20/20 [==============================] - 24s 1s/step - loss: 6.8662e-05 - accuracy: 1.0000 - auc: 1.0000 - false_negatives: 0.0000e+00 - false_positives: 0.0000e+00 - precision: 1.0000 - recall: 1.0000
Epoch 11/15
20/20 [==============================] - 26s 1s/step - loss: 3.5201e-05 - accuracy: 1.0000 - auc: 1.0000 - false_negatives: 0.0000e+00 - false_positives: 0.0000e+00 - precision: 1.0000 - recall: 1.0000
Epoch 12/15
20/20 [==============================] - 29s 1s/step - loss: 2.7668e-05 - accuracy: 1.0000 - auc: 1.0000 - false_negatives: 0.0000e+00 - false_positives: 0.0000e+00 - precision: 1.0000 - recall: 1.0000
Epoch 13/15
 3/20 [===&gt;..........................] - ETA: 16s - loss: 9.7103e-05 - accuracy: 1.0000 - auc: 1.0000 - false_negatives: 0.0000e+00 - false_positives: 0.0000e+00 - precision: 1.0000 - recall: 1.0000</code></pre>
</div>
<div class="output error" data-ename="KeyboardInterrupt"
data-evalue="ignored">
<pre><code>---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)
&lt;ipython-input-43-d3479ad34823&gt; in &lt;cell line: 1&gt;()
----&gt; 1 model, history, test = experiment_model(cnns.vgg16,
      2                                         cnns.VGG16(include_top=False,
      3                                                    input_shape=(200,200,3)),
      4                                         (200,200), &quot;DR&quot;)

&lt;ipython-input-29-bd33c53f432a&gt; in experiment_model(preprocessing_function, model, input_size, target_label)
     10     modelbuilder.add_final_layer()
     11     modelbuilder.compile_model()
---&gt; 12     modelbuilder.train_model()
     13     return modelbuilder.model, modelbuilder.history, test  #La función devuelve el modelo entrenado, el historial del entrenamiento y el conjunto de prueba.

&lt;ipython-input-28-c07cc24b4757&gt; in train_model(self)
     29                                     tf.keras.metrics.Recall(name=&quot;recall&quot;)])
     30     def train_model(self):
---&gt; 31         self.history = self.model.fit(self.train,
     32                                   batch_size=32,
     33                                   epochs=15,

/usr/local/lib/python3.10/dist-packages/keras/src/utils/traceback_utils.py in error_handler(*args, **kwargs)
     63         filtered_tb = None
     64         try:
---&gt; 65             return fn(*args, **kwargs)
     66         except Exception as e:
     67             filtered_tb = _process_traceback_frames(e.__traceback__)

/usr/local/lib/python3.10/dist-packages/keras/src/engine/training.py in fit(self, x, y, batch_size, epochs, verbose, callbacks, validation_split, validation_data, shuffle, class_weight, sample_weight, initial_epoch, steps_per_epoch, validation_steps, validation_batch_size, validation_freq, max_queue_size, workers, use_multiprocessing)
   1781                         ):
   1782                             callbacks.on_train_batch_begin(step)
-&gt; 1783                             tmp_logs = self.train_function(iterator)
   1784                             if data_handler.should_sync:
   1785                                 context.async_wait()

/usr/local/lib/python3.10/dist-packages/tensorflow/python/util/traceback_utils.py in error_handler(*args, **kwargs)
    148     filtered_tb = None
    149     try:
--&gt; 150       return fn(*args, **kwargs)
    151     except Exception as e:
    152       filtered_tb = _process_traceback_frames(e.__traceback__)

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/polymorphic_function/polymorphic_function.py in __call__(self, *args, **kwds)
    829 
    830       with OptionalXlaContext(self._jit_compile):
--&gt; 831         result = self._call(*args, **kwds)
    832 
    833       new_tracing_count = self.experimental_get_tracing_count()

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/polymorphic_function/polymorphic_function.py in _call(self, *args, **kwds)
    865       # In this case we have created variables on the first call, so we run the
    866       # defunned version which is guaranteed to never create variables.
--&gt; 867       return tracing_compilation.call_function(
    868           args, kwds, self._no_variable_creation_config
    869       )

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/polymorphic_function/tracing_compilation.py in call_function(args, kwargs, tracing_options)
    137   bound_args = function.function_type.bind(*args, **kwargs)
    138   flat_inputs = function.function_type.unpack_inputs(bound_args)
--&gt; 139   return function._call_flat(  # pylint: disable=protected-access
    140       flat_inputs, captured_inputs=function.captured_inputs
    141   )

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/polymorphic_function/concrete_function.py in _call_flat(self, tensor_inputs, captured_inputs)
   1262         and executing_eagerly):
   1263       # No tape is watching; skip to running the function.
-&gt; 1264       return self._inference_function.flat_call(args)
   1265     forward_backward = self._select_forward_and_backward_functions(
   1266         args,

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/polymorphic_function/atomic_function.py in flat_call(self, args)
    215   def flat_call(self, args: Sequence[core.Tensor]) -&gt; Any:
    216     &quot;&quot;&quot;Calls with tensor inputs and returns the structured output.&quot;&quot;&quot;
--&gt; 217     flat_outputs = self(*args)
    218     return self.function_type.pack_output(flat_outputs)
    219 

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/polymorphic_function/atomic_function.py in __call__(self, *args)
    250         with record.stop_recording():
    251           if self._bound_context.executing_eagerly():
--&gt; 252             outputs = self._bound_context.call_function(
    253                 self.name,
    254                 list(args),

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/context.py in call_function(self, name, tensor_inputs, num_outputs)
   1477     cancellation_context = cancellation.context()
   1478     if cancellation_context is None:
-&gt; 1479       outputs = execute.execute(
   1480           name.decode(&quot;utf-8&quot;),
   1481           num_outputs=num_outputs,

/usr/local/lib/python3.10/dist-packages/tensorflow/python/eager/execute.py in quick_execute(op_name, num_outputs, inputs, attrs, ctx, name)
     58         for t in inputs
     59     ]
---&gt; 60     tensors = pywrap_tfe.TFE_Py_Execute(ctx._handle, device_name, op_name,
     61                                         inputs, attrs, num_outputs)
     62   except core._NotOkStatusException as e:

KeyboardInterrupt: 
</code></pre>
</div>
</div>
<div class="cell markdown" id="Tndx2zPIt9Og">
<p><strong>HASTA AQUÍ (el resto que hay por debajo está por
ver)</strong></p>
</div>
<div class="cell code" id="mkl81mPmTy-y">
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> ThresholdTuner(model, test)</span></code></pre></div>
</div>
<div class="cell code" id="kLbts5LMTzBY">
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tuner.find_optimal_thresholds()</span></code></pre></div>
</div>
<div class="cell code" id="_7Rq5deUuCpl">
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<div class="cell code" id="5Ov2kkYATzEx">
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>me <span class="op">=</span> ModelEvaluator(history, [<span class="st">&quot;Not Infected&quot;</span>, <span class="st">&quot;Infected&quot;</span>], model, test, tuner.threshold)</span></code></pre></div>
</div>
<div class="cell code" id="BsAZtK2AUC4J">
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>me.training_history()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>me.predict()</span></code></pre></div>
</div>
<div class="cell code" id="ab9pxhDFUC7M">
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>me.class_report()</span></code></pre></div>
</div>
<div class="cell code" id="dsA9zhJrUC_W">
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>dr[<span class="st">&quot;VGG16&quot;</span>] <span class="op">=</span> {<span class="st">&quot;Predictions&quot;</span>: tuner.predictions_raw.tolist(),</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Threshold&quot;</span>: <span class="bu">float</span>(tuner.threshold),</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Ground Truth&quot;</span> : tuner.test.labels,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;History&quot;</span> : history.history</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>               }</span></code></pre></div>
</div>
<div class="cell code" id="8C08uQduUDCq">
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;/kaggle/working/MH.json&quot;</span>, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> fp:</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    json.dump(mh, fp)</span></code></pre></div>
</div>
<div class="cell code" id="dq9apubbUjX8">
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelComparison:</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialization of the class using the required parameters.</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, json_file_path : <span class="bu">str</span>, dataset : <span class="bu">str</span>):</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.history <span class="op">=</span> json.load(<span class="bu">open</span>(json_file_path, <span class="st">&quot;r&quot;</span>))</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dataset <span class="op">=</span> dataset</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.colors <span class="op">=</span> [<span class="st">&quot;red&quot;</span>, <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;yellow&quot;</span>, <span class="st">&quot;green&quot;</span>]</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models <span class="op">=</span> [<span class="st">&#39;EfficientNetB0&#39;</span>, <span class="st">&#39;ResNet152&#39;</span>, <span class="st">&#39;VGG16&#39;</span>, <span class="st">&#39;DenseNet169&#39;</span>]</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plotting a particular metric for all models.</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __plot_metric(<span class="va">self</span>, ax, metric: <span class="bu">str</span>):</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.models)):</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>            ax.plot(<span class="va">self</span>.history[<span class="va">self</span>.models[model_idx]][<span class="st">&quot;History&quot;</span>][metric],</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="va">self</span>.colors[model_idx])</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>        ax.title.set_text(metric <span class="op">+</span> <span class="st">&quot; Comparison&quot;</span>)</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">&#39;Epochs&#39;</span>)</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(metric.title())</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>        ax.legend(<span class="va">self</span>.models)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plotting the comparative analysis of models based on</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># training history.</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> training_history(<span class="va">self</span>):</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>        columns <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> [<span class="st">&quot;val_loss&quot;</span>, <span class="st">&quot;val_accuracy&quot;</span>, <span class="st">&quot;val_auc&quot;</span>, <span class="st">&quot;val_false_positives&quot;</span>, <span class="st">&quot;val_precision&quot;</span>, <span class="st">&quot;val_recall&quot;</span>]</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>        fig, axs <span class="op">=</span> plt.subplots(rows, columns,</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>                                figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">15</span>))</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.__plot_metric(axs[c<span class="op">//</span>columns, c<span class="op">%</span>columns],</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>                               metric)</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>            c <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>        fig.suptitle(<span class="st">&quot;Comparison of Model Performance on &quot;</span><span class="op">+</span><span class="va">self</span>.dataset)</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>        plt.subplots_adjust(bottom<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>                            top<span class="op">=</span><span class="fl">0.9</span>, hspace<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> comparative_roc_curve(<span class="va">self</span>):</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>        plt.plot([<span class="dv">0</span>,<span class="dv">1</span>], [<span class="dv">0</span>,<span class="dv">1</span>], linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, label<span class="op">=</span><span class="st">&#39;No Skill&#39;</span>, color<span class="op">=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model, color <span class="kw">in</span> <span class="bu">zip</span>(<span class="va">self</span>.models, <span class="va">self</span>.colors):</span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>            ground_truth <span class="op">=</span> <span class="va">self</span>.history[model][<span class="st">&quot;Ground Truth&quot;</span>]</span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> <span class="va">self</span>.history[model][<span class="st">&quot;Predictions&quot;</span>]</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>            fpr, tpr, thresholds <span class="op">=</span> roc_curve(ground_truth, predictions)</span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>            plt.plot(fpr, tpr, marker<span class="op">=</span><span class="st">&#39;.&#39;</span>, label<span class="op">=</span>model.replace(<span class="st">&quot;_&quot;</span>,<span class="st">&quot;&quot;</span>), color<span class="op">=</span>color)</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">&quot;Comparative ROC Curve for Binary Classifier&quot;</span>)</span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">&quot;False Positive Rate&quot;</span>)</span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">&quot;True Positive Rate&quot;</span>)</span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>        plt.show()</span></code></pre></div>
</div>
<div class="cell code" id="hvArcoxNUjbI">
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>mc <span class="op">=</span> ModelComparison(<span class="st">&quot;/kaggle/input/modelinfo/DR.json&quot;</span>, <span class="st">&quot;DR&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="v1MTnjHvUjeC">
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>mc.training_history()</span></code></pre></div>
</div>
<div class="cell code" id="gaR6gA60Ujgj">
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>mc.comparative_roc_curve()</span></code></pre></div>
</div>
<div class="cell code" id="9SgUZee-Ujjb">
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Ensembles:</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, json_file : <span class="bu">str</span>, disease : <span class="bu">str</span>, models_in_ensemble : <span class="bu">list</span>):</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> json.load(<span class="bu">open</span>(json_file, <span class="st">&quot;r&quot;</span>))</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.disease <span class="op">=</span> disease</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models_in_ensemble <span class="op">=</span> models_in_ensemble</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.thresholds <span class="op">=</span> np.array([])</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.raw_predictions <span class="op">=</span> <span class="va">None</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.predictions_dimensions <span class="op">=</span> np.array(<span class="va">self</span>.model[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Predictions&quot;</span>]).shape</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.__extract_thresholds()</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_predictions <span class="op">=</span> <span class="va">None</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">#self.final_raw_predictions = None</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __extract_thresholds(<span class="va">self</span>):</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> m <span class="kw">in</span> <span class="va">self</span>.models_in_ensemble:</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.thresholds <span class="op">=</span> np.append(<span class="va">self</span>.thresholds, <span class="va">self</span>.model[m][<span class="st">&quot;Threshold&quot;</span>])</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> __clip_logits(<span class="va">self</span>, a, toe : <span class="bu">str</span>):</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> toe <span class="op">==</span> <span class="st">&quot;mean&quot;</span>:</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>           precision, recall, thresholds <span class="op">=</span> precision_recall_curve(<span class="va">self</span>.test.labels, <span class="va">self</span>.predictions_raw)</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>           fscore <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall)</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>           ix <span class="op">=</span> np.argmax(fscore)</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>           <span class="bu">print</span>(<span class="st">&#39;Best Threshold=</span><span class="sc">%f</span><span class="st">, F-score=</span><span class="sc">%.3f</span><span class="st"> using PR Curve&#39;</span> <span class="op">%</span> (thresholds[ix], fscore[ix]))</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>           <span class="cf">return</span> <span class="bu">int</span>(a <span class="op">&gt;=</span> threshold[ix])</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="bu">int</span>, a <span class="op">&gt;=</span> <span class="va">self</span>.thresholds))</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mean_ensemble(<span class="va">self</span>, evaluate : <span class="bu">bool</span>):</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>        overall_predictions_raw <span class="op">=</span> np.zeros(<span class="va">self</span>.predictions_dimensions)</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> weak_learner <span class="kw">in</span> <span class="va">self</span>.models_in_ensemble:</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>            overall_predictions_raw <span class="op">+=</span> <span class="va">self</span>.model[weak_learner][<span class="st">&quot;Predictions&quot;</span>]</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>        overall_predictions_raw <span class="op">/=</span> <span class="bu">len</span>(<span class="va">self</span>.models_in_ensemble)</span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>        precision, recall, thresholds <span class="op">=</span> precision_recall_curve(<span class="va">self</span>.model[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>],</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>                                                               overall_predictions_raw)</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>        fscore <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall)</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span> np.argmax(fscore)</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Best Threshold=</span><span class="sc">%f</span><span class="st">&#39;</span> <span class="op">%</span> (thresholds[ix]))</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>        overall_predictions <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> k : k <span class="op">&gt;=</span> thresholds[ix], overall_predictions_raw))</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_predictions <span class="op">=</span> overall_predictions</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> evaluate:</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>           <span class="va">self</span>.evaluate_ensemble(<span class="va">self</span>.model[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>], overall_predictions)</span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mode_ensemble(<span class="va">self</span>, evaluate : <span class="bu">bool</span>):</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>        overall_predictions <span class="op">=</span> []</span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> weak_learner <span class="kw">in</span> <span class="va">self</span>.models_in_ensemble:</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>            model_predictions <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> k : k <span class="op">&gt;=</span> <span class="va">self</span>.model[weak_learner][<span class="st">&quot;Threshold&quot;</span>],</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>                                    <span class="va">self</span>.model[weak_learner][<span class="st">&quot;Predictions&quot;</span>]))</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>            overall_predictions.append(model_predictions)</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>        overall_predictions <span class="op">=</span> np.array(overall_predictions)</span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(overall_predictions.shape)</span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>        overall_predictions <span class="op">=</span> st.mode(overall_predictions).mode.flatten()</span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(overall_predictions.shape)</span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_predictions <span class="op">=</span> overall_predictions</span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> evaluate:</span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>           <span class="va">self</span>.evaluate_ensemble(<span class="va">self</span>.model[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>], overall_predictions)</span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> weighted_avg_ensemble(<span class="va">self</span>, evaluate : <span class="bu">bool</span>):</span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>        overall_predictions_raw <span class="op">=</span> np.zeros(<span class="va">self</span>.predictions_dimensions)</span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>        f1_scores <span class="op">=</span> []</span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> weak_learner <span class="kw">in</span> <span class="va">self</span>.models_in_ensemble:</span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a>            model_predictions <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> k : k <span class="op">&gt;=</span> <span class="va">self</span>.model[weak_learner][<span class="st">&quot;Threshold&quot;</span>],</span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a>                                    <span class="va">self</span>.model[weak_learner][<span class="st">&quot;Predictions&quot;</span>]))</span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a>            f1 <span class="op">=</span> f1_score(<span class="va">self</span>.model[weak_learner][<span class="st">&quot;Ground Truth&quot;</span>], model_predictions)</span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a>            f1_scores.append(f1)</span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>            overall_predictions_raw <span class="op">+=</span> np.array(<span class="va">self</span>.model[weak_learner][<span class="st">&quot;Predictions&quot;</span>])<span class="op">*</span>f1</span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a>        overall_predictions_raw <span class="op">/=</span> <span class="bu">sum</span>(f1_scores)</span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a>        precision, recall, thresholds <span class="op">=</span> precision_recall_curve(<span class="va">self</span>.model[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>],</span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a>                                                               overall_predictions_raw)</span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>        fscore <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall)</span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span> np.argmax(fscore)</span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Best Threshold=</span><span class="sc">%f</span><span class="st">&#39;</span><span class="op">%</span> (thresholds[ix]))</span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>        overall_predictions <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> k : k <span class="op">&gt;=</span> thresholds[ix], overall_predictions_raw))</span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_predictions <span class="op">=</span> overall_predictions</span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> evaluate:</span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>           <span class="va">self</span>.evaluate_ensemble(<span class="va">self</span>.model[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>], overall_predictions)</span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_ensemble(<span class="va">self</span>, ground_truth, predictions):</span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a>        sns.heatmap(tf.math.confusion_matrix(ground_truth, predictions, num_classes<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a>                    annot<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">&quot;crest&quot;</span>)</span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(classification_report(ground_truth, predictions, target_names<span class="op">=</span>[<span class="st">&quot;Not Infected&quot;</span>, <span class="st">&quot;Infected&quot;</span>]))</span></code></pre></div>
</div>
<div class="cell code" id="QPPz7-JCVee5">
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>e <span class="op">=</span> Ensembles(<span class="st">&quot;/kaggle/input/modelinfo/DR.json&quot;</span>, <span class="st">&quot;DR&quot;</span>,</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>              [<span class="st">&quot;EfficientNetB0&quot;</span>, <span class="st">&quot;DenseNet169&quot;</span>, <span class="st">&quot;VGG16&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code" id="KVW0TtveVeqb">
<div class="sourceCode" id="cb83"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>e.mean_ensemble(<span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code" id="M7PZNEa9Vew_">
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>e.weighted_avg_ensemble(<span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code" id="-kn0XvCXVe0Y">
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>e.mode_ensemble(<span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code" id="ku9R2ziTVe3v">
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultilabelClassifier:</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, json_dr : <span class="bu">str</span>, json_mh : <span class="bu">str</span>, dr_fx : <span class="bu">str</span>):</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dr <span class="op">=</span> json.load(<span class="bu">open</span>(json_dr, <span class="st">&quot;r&quot;</span>))</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mh <span class="op">=</span> json.load(<span class="bu">open</span>(json_mh, <span class="st">&quot;r&quot;</span>))</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dr_fx <span class="op">=</span> dr_fx</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dr_pred <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dr_raw <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mh_fx <span class="op">=</span> <span class="st">&quot;mode&quot;</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mh_pred <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mh_raw <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models <span class="op">=</span> [<span class="st">&quot;EfficientNetB0&quot;</span>, <span class="st">&quot;DenseNet169&quot;</span>, <span class="st">&quot;VGG16&quot;</span>]</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pred_raw <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pred <span class="op">=</span> <span class="va">None</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> classifier(<span class="va">self</span>):</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> Ensembles(<span class="st">&quot;/kaggle/input/modelinfo/DR.json&quot;</span>, <span class="st">&quot;DR&quot;</span>,</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>                      [<span class="st">&quot;EfficientNetB0&quot;</span>, <span class="st">&quot;DenseNet169&quot;</span>, <span class="st">&quot;VGG16&quot;</span>])</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.dr_fx <span class="op">==</span> <span class="st">&quot;mean&quot;</span>:</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>            e.mean_ensemble(<span class="va">False</span>)</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">#self.dr_</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dr_pred <span class="op">=</span> e.final_predictions</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.dr_fx <span class="op">==</span> <span class="st">&quot;mode&quot;</span>:</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>            e.mode_ensemble(<span class="va">False</span>)</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dr_pred <span class="op">=</span> e.final_predictions</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.dr_fx <span class="op">==</span> <span class="st">&quot;wmean&quot;</span>:</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>            e.weighted_avg_ensemble(<span class="va">False</span>)</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dr_pred <span class="op">=</span> e.final_predictions</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> Ensembles(<span class="st">&quot;/kaggle/input/modelinfo/MH.json&quot;</span>, <span class="st">&quot;MH&quot;</span>,</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>                      [<span class="st">&quot;EfficientNetB0&quot;</span>, <span class="st">&quot;DenseNet169&quot;</span>, <span class="st">&quot;VGG16&quot;</span>])</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>        m.mode_ensemble(<span class="va">False</span>)</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mh_pred <span class="op">=</span> m.final_predictions</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(self.dr_pred)</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pred <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="va">self</span>.dr_pred, <span class="va">self</span>.mh_pred))</span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ground_truth <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(<span class="va">self</span>.dr[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>],</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>                                     <span class="va">self</span>.mh[<span class="st">&quot;VGG16&quot;</span>][<span class="st">&quot;Ground Truth&quot;</span>]))</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_classifier(<span class="va">self</span>):</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(classification_report(<span class="va">self</span>.ground_truth, <span class="va">self</span>.pred,</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>                                    target_names<span class="op">=</span>[<span class="st">&quot;DR&quot;</span>, <span class="st">&quot;MH&quot;</span>]))</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(roc_auc_score(<span class="va">self</span>.ground_truth, <span class="va">self</span>.pred))</span></code></pre></div>
</div>
<div class="cell code" id="qSPiyGeHVuie">
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>multilabel <span class="op">=</span> MultilabelClassifier(<span class="st">&quot;/kaggle/input/modelinfo/DR.json&quot;</span>,</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;/kaggle/input/modelinfo/MH.json&quot;</span>,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;mean&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="t4BWAzpLVuqV">
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>multilabel.classifier()</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>multilabel.evaluate_classifier()</span></code></pre></div>
</div>
<div class="cell code" id="jNOdE9EqVuxj">
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>multilabel <span class="op">=</span> MultilabelClassifier(<span class="st">&quot;/kaggle/input/modelinfo/DR.json&quot;</span>,</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;/kaggle/input/modelinfo/MH.json&quot;</span>,</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&quot;mode&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code" id="t3MQTreSWCzL">
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>multilabel.classifier()</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>multilabel.evaluate_classifier()</span></code></pre></div>
</div>
<div class="cell code" id="bhe85JJ8Hxpn">
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:140}"
id="znA_MIa6Hx2V" data-outputId="4a25be37-8075-42d7-ec9f-f2cb42d08a3f">
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> experiment_model(preprocessing_function, model, input_size : <span class="bu">tuple</span>, target_label : <span class="bu">str</span>):</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ImagePreprocessor(preprocessing_function,</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>                                     input_size,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                                     target_label)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    preprocessor.create_generators()</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    train, test <span class="op">=</span> preprocessor.preprocess()</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    modelbuilder <span class="op">=</span> TransferLearning(train<span class="op">=</span>train,</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>                                val,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>                                model<span class="op">=</span>model,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>                                classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    modelbuilder.mark_layers_non_trainable()</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    modelbuilder.add_final_layer()</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    modelbuilder.compile_model()</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    modelbuilder.train_model()</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelbuilder.model, modelbuilder.history, test</span></code></pre></div>
<div class="output error" data-ename="SyntaxError"
data-evalue="ignored">
<pre><code>  File &quot;&lt;ipython-input-133-f3c8f1380cab&gt;&quot;, line 10
    classes=2)
             ^
SyntaxError: positional argument follows keyword argument

</code></pre>
</div>
</div>
<div class="cell markdown" id="4ksVvb9rWkgJ">
<p>probar el: <a
href="https://www.kaggle.com/code/kaylaqueenazima/multi-label-modified"
class="uri">https://www.kaggle.com/code/kaylaqueenazima/multi-label-modified</a></p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="Djs23zvGfhJ2" data-outputId="7260272b-3d0c-4953-fb27-1ed4245de5eb">
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>pip install opencv<span class="op">-</span>python</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Requirement already satisfied: opencv-python in /usr/local/lib/python3.10/dist-packages (4.8.0.76)
Requirement already satisfied: numpy&gt;=1.21.2 in /usr/local/lib/python3.10/dist-packages (from opencv-python) (1.23.5)
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:245}"
id="TAsOVCuQfluM" data-outputId="b3453d7e-ebb9-4582-8eb8-393f364af239">
<div class="sourceCode" id="cb96"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Directorio que contiene las imágenes</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>directory_path <span class="op">=</span> <span class="st">&quot;/content/drive/MyDrive/Trabajo_Retina/Training_Set/TRAIN&quot;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtener una lista de nombres de archivos en el directorio</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>file_list <span class="op">=</span> os.listdir(directory_path)</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterar sobre cada archivo en el directorio</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> filename <span class="kw">in</span> file_list:</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Comprobar si el archivo es una imagen (puedes ajustar las extensiones según tus necesidades)</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filename.endswith((<span class="st">&#39;.png&#39;</span>, <span class="st">&#39;.jpg&#39;</span>, <span class="st">&#39;.jpeg&#39;</span>)):</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ruta completa de la imagen</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>        image_path <span class="op">=</span> os.path.join(directory_path, filename)</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Leer la imagen con OpenCV</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> cv2.imread(image_path)</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Obtener las dimensiones de la imagen</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>        height, width, channels <span class="op">=</span> image.shape</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Imprimir las dimensiones de la imagen</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Imagen: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">, Dimensiones: </span><span class="sc">{</span>width<span class="sc">}</span><span class="ss"> x </span><span class="sc">{</span>height<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output error" data-ename="FileNotFoundError"
data-evalue="ignored">
<pre><code>---------------------------------------------------------------------------
FileNotFoundError                         Traceback (most recent call last)
&lt;ipython-input-2-59a48e94c8ab&gt; in &lt;cell line: 8&gt;()
      6 
      7 # Obtener una lista de nombres de archivos en el directorio
----&gt; 8 file_list = os.listdir(directory_path)
      9 
     10 # Iterar sobre cada archivo en el directorio

FileNotFoundError: [Errno 2] No such file or directory: &#39;/content/drive/MyDrive/Trabajo_Retina/Training_Set/TRAIN&#39;
</code></pre>
</div>
</div>
</body>
</html>
